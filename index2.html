<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç­‹ãƒˆãƒ¬ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <!-- PWAç”¨ -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      max-width: 600px;
      margin: auto;
      background: #fafafa;
    }
    h1 { text-align: center; }
    input, select, button {
      font-size: 16px;
      padding: 8px;
    }
    .form-row {
      display: flex;
      gap: 5px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .form-row > * { flex: 1; }
    .month-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 15px 0;
    }
    .summary, #exerciseListDisplay {
      background: #e8f5e9;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .date-block {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .record {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button.delete {
      background: none;
      border: none;
      color: #f44336;
      font-size: 18px;
      font-weight: bold;
    }
    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒ©ãƒ• */
    #calendarGraph {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      margin-bottom: 15px;
    }
    .day-cell {
      width: 100%;
      padding-top: 100%;
      position: relative;
      border-radius: 4px;
      background: #eee;
    }
    .day-cell span {
      position: absolute;
      top: 2px;
      left: 2px;
      font-size: 12px;
    }
  </style>
</head>
<body>

<h1>ç­‹ãƒˆãƒ¬ç®¡ç†</h1>

<div class="form-row">
  <input type="text" id="newExercise" placeholder="æ–°ã—ã„ç¨®ç›®">
  <button onclick="addExercise()">è¿½åŠ </button>
</div>

<div id="exerciseListDisplay"></div>

<div class="form-row">
  <input type="date" id="dateInput">
  <select id="exerciseSelect"></select>
</div>

<div class="form-row">
  <input type="number" id="weightInput" placeholder="é‡é‡(kgãƒ»è‡ªé‡ã¯ç©ºæ¬„)">
  <input type="number" id="valueInput" placeholder="å›æ•° / ç§’">
  <select id="unitSelect">
    <option value="å›">å›</option>
    <option value="ç§’">ç§’</option>
  </select>
</div>

<div class="form-row">
  <input type="number" id="setsInput" placeholder="ã‚»ãƒƒãƒˆæ•°" min="1" value="1">
</div>

<div class="form-row">
  <button onclick="addWorkout()">è¿½åŠ </button>
</div>

<hr>

<div class="month-nav">
  <button onclick="changeMonth(-1)">â—€</button>
  <h2 id="monthTitle"></h2>
  <button onclick="changeMonth(1)">â–¶</button>
</div>

<div id="summary" class="summary"></div>

<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒ©ãƒ• -->
<div id="calendarGraph"></div>

<div id="calendar"></div>

<script>
  // --- ãƒ‡ãƒ¼ã‚¿ ---
  const exerciseList = ["ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹", "ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ", "ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ"];
  let workouts = [];
  let currentMonth = new Date();

  const exerciseSelect = document.getElementById("exerciseSelect");
  const dateInput = document.getElementById("dateInput");
  const weightInput = document.getElementById("weightInput");
  const valueInput = document.getElementById("valueInput");
  const unitSelect = document.getElementById("unitSelect");
  const setsInput = document.getElementById("setsInput");
  const monthTitle = document.getElementById("monthTitle");
  const exerciseListDisplay = document.getElementById("exerciseListDisplay");

  function saveData() { localStorage.setItem("workouts", JSON.stringify(workouts)); }
  function loadData() { workouts = JSON.parse(localStorage.getItem("workouts")||"[]"); }
  loadData();

  function updateExerciseOptions() {
    exerciseSelect.innerHTML = '<option value="">ç¨®ç›®ã‚’é¸æŠ</option>';
    exerciseList.forEach(ex=>{
      const o=document.createElement("option"); o.value=ex; o.textContent=ex; exerciseSelect.appendChild(o);
    });
  }
  updateExerciseOptions();

  function renderExerciseList(){
    exerciseListDisplay.innerHTML="<strong>ç™»éŒ²æ¸ˆã¿ç¨®ç›®</strong><br>";
    exerciseList.forEach((ex,i)=>{
      const div=document.createElement("div");
      div.innerHTML=`${ex} <button onclick="editExercise(${i})">âœ</button> <button onclick="deleteExercise(${i})">ğŸ—‘</button>`;
      exerciseListDisplay.appendChild(div);
    });
  }

  function editExercise(index){
    const newName = prompt("æ–°ã—ã„ç¨®ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", exerciseList[index]);
    if(newName && !exerciseList.includes(newName)){
      workouts.forEach(w=>{if(w.exercise===exerciseList[index]) w.exercise=newName;});
      exerciseList[index]=newName;
      saveData(); updateExerciseOptions(); render();
    }
  }

  function deleteExercise(index){
    if(!confirm(`${exerciseList[index]}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ã“ã®ç¨®ç›®ã®å…¨è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™`)) return;
    const nameToDelete=exerciseList[index];
    workouts=workouts.filter(w=>w.exercise!==nameToDelete);
    exerciseList.splice(index,1);
    saveData(); updateExerciseOptions(); render(); renderExerciseList();
  }

  function addExercise(){
    const name=document.getElementById("newExercise").value.trim();
    if(name && !exerciseList.includes(name)){
      exerciseList.push(name);
      updateExerciseOptions(); document.getElementById("newExercise").value="";
      renderExerciseList();
    }
  }

  function addWorkout(){
    const date=dateInput.value, exercise=exerciseSelect.value, value=valueInput.value, unit=unitSelect.value;
    const weightVal=weightInput.value, sets=setsInput.value?Number(setsInput.value):1;
    if(!date||!exercise||!value) return;
    workouts.push({date, exercise, value:Number(value), unit, weight:weightVal?Number(weightVal):null, sets});
    workouts.sort((a,b)=>new Date(a.date)-new Date(b.date));
    saveData(); dateInput.value=""; exerciseSelect.value=""; valueInput.value=""; weightInput.value=""; setsInput.value="1"; unitSelect.value="å›"; render();
  }

  function deleteWorkout(i){workouts.splice(i,1); saveData(); render();}
  function changeMonth(diff){currentMonth.setMonth(currentMonth.getMonth()+diff); render();}

  function render(){
    renderSummary();
    renderCalendar();
    renderExerciseList();
    renderCalendarGraph();
  }

  function renderSummary(){
    const s=document.getElementById("summary");
    const y=currentMonth.getFullYear(), m=currentMonth.getMonth();
    const monthData=workouts.filter(w=>new Date(w.date).getFullYear()===y && new Date(w.date).getMonth()===m);
    if(monthData.length===0){s.textContent="ã“ã®æœˆã®é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“"; return;}
    const days=new Set(monthData.map(w=>w.date)).size;
    const byExercise={};
    monthData.forEach(w=>{if(!byExercise[w.exercise]) byExercise[w.exercise]={å›:0,ç§’:0,sets:0}; byExercise[w.exercise][w.unit]+=w.value; byExercise[w.exercise].sets+=w.sets;});
    let html=`<strong>ğŸ“Š æœˆé›†è¨ˆ</strong><br>ãƒ»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ—¥æ•°ï¼š${days}æ—¥<br>ãƒ»ç·ã‚»ãƒƒãƒˆæ•°ï¼š${monthData.reduce((a,w)=>a+w.sets,0)}ã‚»ãƒƒãƒˆ<br><br>`;
    Object.keys(byExercise).forEach(ex=>{
      html+=`<strong>${ex}</strong><br>`;
      if(byExercise[ex]["å›"]) html+=`ã€€${byExercise[ex]["å›"]}å› Ã— ${byExercise[ex].sets}ã‚»ãƒƒãƒˆ<br>`;
      if(byExercise[ex]["ç§’"]) html+=`ã€€${byExercise[ex]["ç§’"]}ç§’ Ã— ${byExercise[ex].sets}ã‚»ãƒƒãƒˆ<br>`;
    });
    s.innerHTML=html;
  }

  function renderCalendar(){
    const c=document.getElementById("calendar"); c.innerHTML="";
    const y=currentMonth.getFullYear(), m=currentMonth.getMonth(); monthTitle.textContent=`${y}å¹´ ${m+1}æœˆ`;
    const monthData=workouts.filter(w=>new Date(w.date).getFullYear()===y && new Date(w.date).getMonth()===m);
    const grouped={}; monthData.forEach(w=>{if(!grouped[w.date]) grouped[w.date]=[]; grouped[w.date].push(w);});
    Object.keys(grouped).sort().forEach(date=>{
      const b=document.createElement("div"); b.className="date-block"; b.innerHTML=`<h3>${date}</h3>`;
      grouped[date].forEach(w=>{
        const text=w.weight!==null?`${w.exercise}ï¼š${w.weight}kg Ã— ${w.value}${w.unit} Ã— ${w.sets}ã‚»ãƒƒãƒˆ`:`${w.exercise}ï¼šè‡ªé‡ Ã— ${w.value}${w.unit} Ã— ${w.sets}ã‚»ãƒƒãƒˆ`;
        b.innerHTML+=`<div class="record"><span>${text}</span><button class="delete" onclick="deleteWorkout(${workouts.indexOf(w)})">Ã—</button></div>`;
      });
      c.appendChild(b);
    });
  }

  // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒ©ãƒ• ---
  function renderCalendarGraph(){
    const graph = document.getElementById("calendarGraph");
    graph.innerHTML = "";
    const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
    const firstDay = new Date(y, m, 1);
    const lastDay = new Date(y, m+1, 0);

    // ç©ºç™½ã‚»ãƒ«
    for(let i=0;i<firstDay.getDay();i++){
      const empty = document.createElement("div"); empty.className="day-cell"; graph.appendChild(empty);
    }

    for(let d=1; d<=lastDay.getDate(); d++){
      const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const dayWorkouts = workouts.filter(w=>w.date===dateStr);
      const totalSets = dayWorkouts.reduce((sum,w)=>sum+w.sets,0);

      const cell=document.createElement("div");
      cell.className="day-cell";
      cell.title=`${dateStr}ï¼š${totalSets}ã‚»ãƒƒãƒˆ`;
      cell.style.background = totalSets===0 ? "#eee" :
                              totalSets<=3 ? "#a2d5ab" :
                              totalSets<=6 ? "#4caf50" :
                              "#1b5e20";
      cell.innerHTML=`<span>${d}</span>`;
      graph.appendChild(cell);
    }
  }

  render();

  // --- PWA: Service Worker ---
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').then(()=>console.log('Service Workerç™»éŒ²æˆåŠŸ')).catch(console.error);
  }

</script>
</body>
</html>